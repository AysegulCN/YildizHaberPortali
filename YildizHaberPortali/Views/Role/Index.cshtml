@using Microsoft.AspNetCore.Identity
@model IEnumerable<IdentityRole>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="row mb-4">
    <div class="col-md-6">
        <h2 class="text-gray-800">Rol Yönetimi</h2>
    </div>
    <div class="col-md-6 text-right">
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Yeni Rol Oluştur
        </a>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Sistemde Tanımlı Roller</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Rol Adı (Name)</th>
                        <th style="width: 150px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Name</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm btn-delete" data-id="@item.Id">
                                    <i class="fas fa-trash"></i> Sil
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="undo-toast" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11; bottom: 20px; right: 20px;">
    <div class="toast align-items-center text-white bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
        <div class="d-flex">
            <div class="toast-body">
                Rol siliniyor... <span id="countdown-text">5</span>
            </div>
            <button type="button" id="btn-undo" class="btn btn-warning btn-sm m-auto me-2 font-weight-bold">
                <i class="fas fa-undo"></i> GERİ AL
            </button>
        </div>
        <div class="progress" style="height: 3px;">
            <div id="undo-progress" class="progress-bar bg-warning" role="progressbar" style="width: 100%;"></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {

        let deleteTimer;
        let rowToDelete;
        let roleIdToDelete;
        let countdownValue = 5;
        let countdownInterval;

        // Toast elemanını seç (Bootstrap 5)
        var undoToastEl = document.getElementById('undo-toast');
        // Eğer Bootstrap 4 kullanıyorsan aşağıdaki satır hata verebilir, o yüzden jQuery show/hide kullanacağız.

        $(".btn-delete").click(function () {

            if(deleteTimer) forceDeleteNow();

            roleIdToDelete = $(this).data("id");
            rowToDelete = $(this).closest("tr");

            // Satırı gizle
            rowToDelete.fadeOut();

            // Bildirimi manuel göster
            $(".toast").addClass('show').show();

            $("#undo-progress").css("width", "100%");
            $("#undo-progress").css("transition", "width 5s linear");
            countdownValue = 5;
            $("#countdown-text").text(countdownValue);

            setTimeout(() => { $("#undo-progress").css("width", "0%"); }, 100);

            countdownInterval = setInterval(function() {
                countdownValue--;
                $("#countdown-text").text(countdownValue);
                if(countdownValue <= 0) clearInterval(countdownInterval);
            }, 1000);

            deleteTimer = setTimeout(function () {
                forceDeleteNow();
            }, 5000);
        });

        $("#btn-undo").click(function () {
            clearTimeout(deleteTimer);
            clearInterval(countdownInterval);
            deleteTimer = null;
            rowToDelete.fadeIn();
            $(".toast").removeClass('show').hide();
            $("#undo-progress").css("transition", "none");
            $("#undo-progress").css("width", "100%");
        });

        function forceDeleteNow() {
            if (!roleIdToDelete) return;

            $.ajax({
                type: "POST",
                url: "/Role/DeleteRole", // Controller adresine dikkat
                data: { roleId: roleIdToDelete },
                success: function (response) {
                    if (response.success) {
                        if(rowToDelete) rowToDelete.remove();
                        console.log("Silindi.");
                    } else {
                        if(rowToDelete) rowToDelete.fadeIn();
                        alert(response.message);
                    }
                },
                error: function () {
                    if(rowToDelete) rowToDelete.fadeIn();
                    alert("Sunucu hatası!");
                }
            });

            $(".toast").removeClass('show').hide();
            clearTimeout(deleteTimer);
            clearInterval(countdownInterval);
        }
    });
</script>